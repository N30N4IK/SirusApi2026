# Hotel & Flight Booking Aggregator API

Этот проект представляет собой реализацию API для сервиса бронирования отелей и авиабилетов, построенного на фреймворке **FastAPI** с использованием принципов **Гексагональной Архитектуры (Ports & Adapters)**.

## Архитектура: Гексагональный Монолит

Проект организован вокруг бизнес-ядра (`core/`) и использует адаптеры для взаимодействия с внешним миром (БД, REST API).

| Слой | Назначение |
| :--- | :--- |
| **`core/domain`** | Сущности и бизнес-правила (User, Hotel, Flight, Booking). |
| **`core/ports`** | Интерфейсы (Ports) для Use Cases и репозиториев. |
| **`core/usecases`** | Реализация бизнес-логики (Поиск рейсов, Бронирование номеров). |
| **`adapters/primary/rest`** | Контроллеры FastAPI (Primary Adapters). |
| **`adapters/secondary/db`** | Адаптеры к БД (Реализация Repository Ports через SQLAlchemy). |
| **`infrastructure`** | Настройка приложения (DI, БД-соединение, JWT). |

## Стек технологий

*   **Фреймворк:** Python 3.13+, FastAPI
*   **База данных:** PostgreSQL (через Docker Compose)
*   **ORM:** SQLAlchemy
*   **Аутентификация:** JWT (python-jose), bcrypt (passlib)
*   **Контейнеризация:** Docker, Docker Compose

## Инструкции по запуску

### 1. Предварительные требования

1.  Установлен Docker Desktop (включая Docker Compose).
2.  Установлен Python 3.13+.

### 2. Сборка и запуск через Docker Compose

Для запуска приложения вместе с базой данных PostgreSQL используйте Docker Compose.

**A. Сборка и запуск:**
Перейдите в корневой каталог проекта (где находится `docker-compose.yml`) и выполните команду:

```bash
docker-compose up --build
```
*Примечание: Команда `sleep 5` в `docker-compose.yml` гарантирует, что приложение подождет, пока база данных будет готова к приему соединений.*

**B. Проверка:**
После запуска приложение будет доступно по адресу: `http://localhost:8000`.

### 3. Инициализация базы данных (Создание таблиц и Админа)

После первого запуска контейнеров, выполните скрипт для создания всех таблиц и учетной записи администратора:

```bash
# Выполнить команду в контейнере API
docker exec -it booking_api python services/scripts/setup_db.py
```
*Скрипт запросит пароль для администратора (`admin@booking.com`).*

## Использование и Тестирование API

Документация API доступна по адресу: `http://localhost:8000/docs`.

### 1. Аутентификация

Для доступа к защищенным маршрутам (CRUD, бронирование, `/users/me`) требуется токен.

| Маршрут | Описание |
| :--- | :--- |
| `POST /users/login` | Вход (email/password). Устанавливает токен в `HttpOnly` Cookie. |
| `GET /users/me` | Получение информации о текущем пользователе. |

**Важно:** Для тестирования используйте учетные данные администратора (`admin@booking.com` и пароль, который вы ввели в `setup_db.py`).

### 2. Тестирование Hotel Service (CRUD для Admins)

*   **Создание отеля (Admin):** `POST /hotels` (Требует токена Admin).
*   **Просмотр (Все):** `GET /hotels` (фильтры по `city`, `stars`).

### 3. Тестирование Booking Service (Свободные номера)

*   **Поиск доступности:** `GET /bookings/rooms/available` (Параметры: `check_in`, `capacity`, `check_out` или `duration_days`).
*   **Бронирование:** `POST /bookings/rooms/book` (Требует токена пользователя).

### 4. Тестирование Flight Service (Графовый поиск)

*   **Поиск рейсов:** `GET /flights/search` (Параметры: `origin`, `destination`, `departure_date`).
    *   API автоматически ищет кратчайший путь с пересадками (макс. 24 часа ожидания) и помечает "самый быстрый" и "самый дешевый" маршруты.

### 5. Остановка и очистка

```bash
docker-compose down
```
*(Используйте `docker-compose down -v` для удаления данных PostgreSQL, если требуется полный сброс.)*